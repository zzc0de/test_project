<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
</head>
<body>
    <h2></h2>
    <form name="deviceForm">
        <input type="hidden" name="id" value="0">
        <div class="form-area">
            <label for="">Brand</label>
            <input type="text" class="form-control" name="brand">
        </div>
        <div class="form-area">
            <label for="">Model</label>
            <input type="text" class="form-control" name="model">
        </div>
        <div class="form-area">
            <label for="">Serial</label>
            <input type="text" class="form-control" name="serial">
        </div>
        <div class="panel-body">
            <button type="submit" class="btn btn-sm btn-primary">Save</button>
            <button id="reset" class="btn btn-sm btn-primary">Reset</button>
        </div>
    </form>
    <table class="table table-condensed table-striped table-bordered">
        <thead><tr><th>Id</th><th>Brand</th><th>Model</th><th></th><th>Serial</th><th></th></tr></thead>
        <tbody>
        </tbody>
    </table>
    <script>
        async function getDevices() {
            let response = await fetch('/api/devices', {
                method: 'GET',
                headers: { 'Accept': 'application/json; charset=utf-8' }
            });

            if (response.ok === true) {
                let devices = await response.json();
                let rows = '';

                for (let device of devices) {
                    rows += row(device);
                }
                tbody = document.querySelector('tbody');
                tbody.insertAdjacentHTML('afterbegin', rows);
            }
        }
        async function getDevice(id) {
            let response = await fetch('/api/devices' + id, {
                method: 'GET',
                headers: { 'Accept': 'application/json'}
            });
            if (response.ok === true) {
                let device = await response.json();
                let form = document.forms['deviceForm'];
                form.elements['id'].value = device.id;
                form.elements['brand'].value = device.brand;
                form.elements['model'].value = device.model;
                form.elements['serial'].value = device.serial;
            }
        }
        function reset() {
            let form = document.forms['deviceForm'];
            form.reset();
            form.elements['id'].value = 0;
        }
        let resetButton = document.getElementById('reset');
        resetButton.addEventListener("click", function (event) {
            event.preventDefault();
            reset();
        })
        function row(device) {
            return `<tr data-rowid="${device.id}">
                  <td>${device.id}</td>
                  <td>${device.brand}</td>
                  <td>${device.model}</td>
                  <td>${device.serial}</td>
                  <td>
                  <button class="editLink" data-id="${device.id}">Change</button>
                  <button class="removeLink" data-id="${device.id}">Remove</button>
                  </td>
                </tr>`
        }

        let form = document.querySelector('form');
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            let id = form.elements['id'].value;
            let brand = form.elements['brand'].value;
            let model = form.elements['model'].value;
            let serial = form.elements['serial'].value;

            if (id === 0) {
                addDevice(brand, model, serial)
            }
        });

        async function addDevice(deviceBrand, deviceModel, deviceSerial) {
            let response = await fetch('/api/devices/', {
                method: 'POST',
                headers: { 'Content-type': 'application/json; charset=utf-8'},
                body: JSON.stringify({
                    brand: deviceBrand,
                    model: deviceModel,
                    serial: deviceSerial
                })
            });
            let device = await response.json();
            device.brand = deviceBrand;
            device.model = deviceModel;
            device.serial = deviceSerial;

            reset();

            let tbody = document.querySelector('tbody');
            tbody.insertAdjacentHTML('beforeend', row(device));
        }

        getDevices()
    </script>
</body>
</html>